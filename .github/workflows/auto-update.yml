---
name: â›‘ï¸ Auto Update Dependencies

on:
  schedule:
    - cron: '0 0 * * *'   # Daily at 00:00 UTC (08:00 SGT)
  workflow_dispatch:       # Manual trigger option
    inputs:
      strategy:
        description: How to publish updates
        type: choice
        options:
          - direct
          - pr
        default: direct
      force_update:
        description: Continue even if checks fail
        type: boolean
        default: false

permissions:
  contents: write
  actions: read
  pull-requests: write

env:
  BOT_TOKEN: ${{ secrets.T800_TOKEN || github.token }}
  HAS_PAT: ${{ secrets.T800_TOKEN != '' }}
  UPDATE_STRATEGY: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.strategy || 'direct' }}
  FORCE_UPDATE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_update || 'false' }}

jobs:
  auto-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ env.BOT_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2.1.2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v5.0.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install current dependencies
        run: bun install

      - name: Update all dependencies
        run: |
          echo "ðŸ”„ Updating dependencies..."
          bun update

          echo "ðŸ” Checking for security vulnerabilities..."
          bun audit || true

      - name: Run quality checks
        run: |
          echo "âœ… Running type checking..."
          bun run type-check

          echo "âœ… Running linter..."
          bun run lint

          echo "âœ… Running tests..."
          bun run test:run
        continue-on-error: ${{ env.FORCE_UPDATE == 'true' }}

      - name: Build project
        run: |
          echo "ðŸ—ï¸ Building project..."
          bun run build

      - name: Check for changes
        id: check_changes
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ No dependency updates available"
          else
            echo "changes=true" >> "$GITHUB_OUTPUT"
            echo "ðŸ“¦ Dependencies updated!"
            git status --porcelain | head -n 200
            git diff --stat | head -n 200
          fi

      - name: Commit and push changes
        id: commit_msg
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # Array of creative commit messages
          MESSAGES=(
            "âœ¨ chore(deps): sprinkle fresh dependency updates like cosmic stardust"
            "ðŸš€ chore(deps): boost dependencies to warp speed - all systems go!"
            "ðŸŽ¨ chore(deps): polish dependencies to stellar perfection"
            "âš¡ chore(deps): supercharge packages with lightning-fast updates"
            "ðŸŒŸ chore(deps): elevate dependencies to new heights of excellence"
            "ðŸ”® chore(deps): enchant codebase with mystical dependency magic"
            "ðŸŽ¯ chore(deps): hit bullseye with precision dependency updates"
            "ðŸŒŠ chore(deps): ride the wave of cutting-edge package versions"
            "ðŸŽª chore(deps): roll out the red carpet for fresh dependencies"
            "ðŸ† chore(deps): crown packages with championship-worthy updates"
            "ðŸŽ­ chore(deps): orchestrate a symphony of updated dependencies"
            "ðŸš chore(deps): airlift dependencies to cloud nine"
            "ðŸŽ¨ chore(deps): paint the town with vibrant new package colors"
            "ðŸ”¥ chore(deps): ignite performance with blazing dependency updates"
            "ðŸ’Ž chore(deps): polish dependencies until they shine like diamonds"
          )

          # Select random message
          RANDOM_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}

          {
            echo "title=${RANDOM_MSG}"
            echo "commit_message=${RANDOM_MSG}"
          } >> "$GITHUB_OUTPUT"

      - name: Commit and push changes (direct)
        if: steps.check_changes.outputs.changes == 'true' && env.UPDATE_STRATEGY == 'direct'
        run: |
          git config --global user.name "${{ github.repository_owner }}"
          git config --global user.email "130107241+oxyzenQ@users.noreply.github.com"

          git add -A
          git commit -m "${{ steps.commit_msg.outputs.commit_message }}" \
            -m "ðŸ¤– Automated by the tireless GitHub Actions Bot" \
            -m "ðŸ“¦ Updated $(git status --porcelain | wc -l) file(s)" \
            -m "â° $(date -u '+%A, %B %d, %Y at %H:%M:%S UTC')" \
            -m "ðŸŽ¯ Workflow: auto-update.yml"
          git push origin main

          echo "âœ… Changes committed and pushed to main!"

      - name: Create pull request (pr)
        id: cpr
        if: steps.check_changes.outputs.changes == 'true' && env.UPDATE_STRATEGY == 'pr'
        uses: peter-evans/create-pull-request@v8.1.0
        with:
          token: ${{ env.BOT_TOKEN }}
          commit-message: ${{ steps.commit_msg.outputs.commit_message }}
          title: ${{ steps.commit_msg.outputs.title }}
          body: ${{ steps.commit_msg.outputs.title }}
          branch: bot/auto-update-deps
          delete-branch: true

      - name: Summary
        if: always()
        run: |
          {
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ðŸ¤– AUTO UPDATE SUMMARY"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Strategy: ${{ env.UPDATE_STRATEGY }}"
            echo "Force Update: ${{ env.FORCE_UPDATE }}"
            echo ""

            if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
              echo "âœ¨ Updates Applied:"
              echo "  - ðŸ“¦ Dependencies updated"
              echo "  - ðŸ”’ Security audit executed"

              echo ""

              if [ "${{ env.UPDATE_STRATEGY }}" == "direct" ]; then
                echo "âœ… Changes pushed to main branch"
                echo "ðŸ“ Commit: $(git rev-parse HEAD)"
              else
                echo "âœ… Pull request created"
                echo "ðŸ”— PR: ${{ steps.cpr.outputs.pull-request-url }}"
              fi
            else
              echo "âœ… No updates needed - everything is current!"

            fi

            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "â° Next run: 00:00 UTC (08:00 SGT)"
            echo "ðŸš€ Manual trigger: Actions â†’ Auto Update Dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          } >> "$GITHUB_STEP_SUMMARY"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
